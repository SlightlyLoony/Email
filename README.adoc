== What is Email?

_Email_ is general purpose email service provider module, handling both outbound and inbound emails.  It does _not_ provide an email service with SMTP, POP3, IMAP4, and so on; it relies on third-party providers such as GMail or Amazon SES for those.  It is _not_ a standalone program, but rather an embedded service provider with a programmatic interface that your code can call to send or receive email.


== Ways that automatically transmitted emails are used

Probably the first thing that comes to mind with automated email are the marketing emails (spam!) that we all hate getting.  Generally speaking, these _bulk emails_ are identical emails that are sent out to many email addresses.  These are by far the simplest type of automated email -- when less than a few hundred destination email addresses are involved, this can be as simple as a single email being sent to a list of email addresses (any combination of To, CC, and BCC).

Automated emails aren't necessarily bulk emails, however -- they can be emails that are specific to a single email address.  For example, Amazon sends me confirmations of the orders that I've placed with them.  Those emails go only (I hope!) to me, and the content is specific to me.  The industry term for this sort of email is _transactional email_, because most often they are part of a transaction of some kind.  However, the key element that distinguishes transactional email from bulk eail is that the former is customized (or, if you will, _personalized_), and the latter is generic; identical for every recipient.

It's worth noting that there really isn't a bright line between the two kinds of automated emails.  For example, I'm working toward providing automated weather report emails to our local community.  I'll likely end up with a few hundred subscribers.  Some of them will get simple text reports, some will get simple graphical reports (with images of thermometers, rain gauges, etc.), some will get detailed reports that include historical information, and some will get still other kinds of reports.  Perhaps I'll end up with a half dozen or so kinds of reports.  So does that mean I have a half dozen different bulk emails going out daily?  Or does it mean that I have transactional email that happens to have only a half dozen variations, instead of one per person?  It doesn't really matter except for one technical detail: you'll likely use different capabilities within _Email_ if you approach it as several kinds of bulk mail versus transactional email with a few variations.

While _Email_ certainly supports bulk mail, most of what it does is aimed at supporting transactional email -- the more complex of the two approaches.

== A bit about email addresses and identities

I tend to think of email addresses as belonging to a _person_, one individual -- but that is not always the case.  I've run into quite a few systems that use email addresses as identifiers, but this turns out to be quite problematic.  Here are some common circumstances that will illuminate why:

* People change their email addresses.  I used to have a Yahoo email address, then I had a generic gmail address, and now I have a gmail address that's on my own domain.  How confusing!
* People may have multiple email addresses (I have 11 at the moment, and have had as many as 30).
* The email address may be for an email group, not an individual.  Many email servers support email groups.  Each member of the group has their own inbox, but if an email is received at the group's collective address, a copy of that email goes to each member of the group (and the sender has no way of knowing who actually gets that email).
* The email address may be for a machine or system, and not a person at all.  There are many systems that use email for inter-process communications, especially where connectivity is spotty.  Some also use it as a way of getting input from users, and such a system is one of the main reasons I'm writing this package.
* The email address may be shared.  I know several couples who have but a single email address, and they actually have a single inbox that both of them use.  Shared email addresses are especially common in organizations, as an alternative to an email group.
* The email address may be for an organization, not an individual.  For instance, many companies have generic email addresses like `support@greenbanana.com` or `sales@rainmaker.com`.  These addresses may actually be for a group within the organization, it may be a shared inbox, or they may go to an individual -- and that individual may change over time.

The upshot of this is that you really are not safe in thinking about an email address being some sort of unique identifier of a person.  The notions of identity and of email addresses are certainly connected, just not one-to-one -- it really is a many-to-many relationship.

Why does this matter to you?  Well, if you're sending emails with personalized information, it means your system really should not use an email address as a unique identifier of a person (or organization, or machine).  For all the reasons above, your system should separate the notions of identities and email addresses, but maintain connections between them.

== Plain email versus HTML email

Almost all modern email clients -- whether on a computer, phone, or tablet -- are capable of rendering HTML mail, complete with colors, different fonts, images and photographs, etc.  Many people have never even _seen_ a plain text email!  However, email clients _do_ exist that are not capable of rendering HTML mail.  Most of these clients are used from the command line on systems like Linux, but not all of them.  I ran into someone a few weeks ago whose Windows laptop was running the Claws email client -- with no capability for displaying HTML mail.  He liked Claws because it was zippy.

So how do you decide whether to use HTML mail or plain text email?  The simplest answer is to leverage a standard part of email technology to send _both_.  That way you'll make everyone happy!

A more challenging issue, really, is around the features you leverage within the HTML of an HTML email.  Unfortunately there is no standard for this, and the various email clients vary wildly.  If you're a developer, I'm sure you won't be surprised to hear that Microsoft's products are, in general, the most "out there" of them all.  There are dozens and dozens of web sites devoted to all the nasty details of designing HTML emails.  After reading through way too many of them, I'll boil their advice down to three things:

* Use tables for layout.
* Stick with the simpler, older HTML constructs.
* Don't expect JavaScript to work.

== Some background on how email actually works

When I first started working on this project, I had a mental model for email that turned out to be far, far too simple.  This section is a sort of primer on modern email, with an emphasis on the things that were new or surprising or unobvious to me.  Writing it all down helps embed it in my own mind, and may be useful for you, too.

=== Email sending protocols

https://en.wikipedia.org/wiki/Simple_Mail_Transfer_Protocol[SMTP] (Simple Mail Transfer Protocol) seems to be the only protocol in general use for sending email.  In that sense, it's pretty darned close to an actual standard, though there are annoying variants that one has to deal with in code.

=== Email receiving protocols

https://en.wikipedia.org/wiki/Post_Office_Protocol[POP3] (Post Office Protocol version 3) and https://en.wikipedia.org/wiki/Internet_Message_Access_Protocol[IMAP] (Internet Message Access Protocol) are the only two in common use.  POP3 is far older and less capable (for instance, it knows nothing about folders), and probably really shouldn't be used anymore.  In _Email_ I'm using IMAP.

=== Email protocols in Java

There are many projects out in the open-source world that implement some combination of SMTP, POP3, and IMAP, but there is one that absolutely dominates: https://www.oracle.com/java/technologies/javamail.html[JavaMail], actively developed at [Eclipse Foundation], who took over in 2017, and renamed it Jakarta Mail.  I've chosen Jakarta Mail (version 2.0.1) as the protocol implementation for _Email_.

=== Email providers

Many organizations host their own email servers, especially (and most unfortunately) with Micrsoft Exchange (hit with https://krebsonsecurity.com/2021/03/at-least-30000-u-s-organizations-newly-hacked-via-holes-in-microsofts-email-software/[quite the hacker problem in 2021]).  Most individuals and smaller companies use third-party email providers, the dominant one of which is https://en.wikipedia.org/wiki/Gmail[gmail].  Any of these providers can be used with _Email_ so long as Jakarta Mail can be configured to support it -- and so far I've not found any email providers that Jakarta Mail _couldn't_ support.

=== The components of an email

There are some basic components of email that we all are familiar with.  Well, that we all _think_ we're familiar with:

* Address: The _To_, _CC_, and _BCC_ that together determine who receives the email.
* Subject: The brief little one-liner that is intended to give the recipient some clue about what the email concerns.
* Body: The actual content of the email.

==== Address

Most of us are by now quite familiar with these two valid formats:
....
mailbox@domain  (like "tom@dilatush.com")
Display Name<mailbox@domain>  (like "Tom Dilatush<tom@dilatush.com>")
....

It may surprise you to know that there are actually quite a few other details.  https://en.wikipedia.org/wiki/Email_address[Wikipedia] has a good article about them.

The biggest surprise for me was finding out that the mailbox part is technically case-sensitive -- so `tom@dilatush.com` and `Tom@dilatush.com` should be two independent email addresses.  I'm not sure I've ever seen that in the while, and apparently both server and client support is spotty, but there it is.
Also I discovered that the mailbox part cannot be more than 64 characters long.

All three address groups (To, CC, and BCC) can accept a number of email addresses, including zero (although if all three have no addresses your email isn't going _anywhere_!).  The maximum number of addressees in each group is dependent on the SMTP provider, and there doesn't seem to be any convention to this, much less a standard.  In every case I've seen personally, you can have well over 100 addresses in each of those address groups.  Some vendors (I'm looking at you, gmail!) limit the total number in all three, rather than having a limit in each address group.

==== Subject

This is the simplest component of an email, but even _it_ has its complications!  While there is no maximimum length that I could find, there is a practical limit: most inboxes on computer clients only show the first 50 or 60 characters of the subject line (generally truncating with an ellipsis, like `This is my WAY too long...`).  Many mobile email clients, when used on a phone, only show 20 or 25 characters.  These limits mean that short subject lines are definitely better, and that the information in them should be front-loaded, so that if some of the subject line _is_ truncated, the poor user can still figure out what the mail is about.

HTML is not disallowed in the subject line, but I've never found an email client that would actually render it.  The RFCs that control email format _still_ specify the subject line as ASCII, but you can control the character encoding of an email, including on the subject line.  _Email_ defaults to UTF-8, but you can change that if you want something different.

==== Body

The body of a modern email can be just ridiculously complex.  This complexity was all enabled by a standard called https://en.wikipedia.org/wiki/MIME[MIME] (Multipurpose Internet Mail Extensions).  Prior to the advent of MIME, email bodies were just plain ASCII text -- ah, those were such simple days!  MIME basically standardizes a way of encoding things other than ASCII-encoded text _into_ plain ASCII-encoded text -- things such as HTML, images, audio, video, attachments, and much more.

The body of a modern email can also be very simple: just a string of ASCII characters.  That's how email started out, and that sort of simple email actually still works just fine.  However, the result is not the fancy thing we're all used to in our email these days.

Much more typical today -- and most likely, the kind of email you'd like to send -- is an email composed in HTML, perhaps with photographs, graphics, and possibly even videos.  You'd still want it to work for a recipient who had an email client that couldn't handle HTML, though.  You can do all of this by using MIME, which is fully supported by _Email_ and Jakarta Mail. Suppose, for instance, that you wanted to create an email that used HTML to format the body, with two _inline_ images (more on that later), and a plain text message for those recipients who couldn't read HTML email.  To do this, you'd create a tree of MIME nodes that looked like this:
....
               (a) multipart: alternative
                   |                    |
        b) content: text/plain      (c) multipart: related
                                        |      |       |
                                        |      |       +-- (f) content: image/jpeg
                                        |      +-- (e) content: image/png
                                        +-- (d) context: text/html
....
You can see there are two kinds of nodes: "multipart" nodes that are simply nodes that contain other nodes, and "content" nodes (that are always leaf nodes) that carry some kind of content.  Taking it one piece at a time:

a.  A multipart whose children are alternative "views" of the email.  In this case, a plain text view and an HMTL view.  Email clients are supposed to prefer the last alternative that they're capable of displaying.
b.  The plain text content, which should only be displayed in email clients that cannot display HTML.
c.  A multipart whose children are all related to each other -- in this case, they're all pieces of the HTML email.
d.  The HTML document, which among other things has `<img/>` tags that refer to the two images (following), via specially formed URLs.
e.  One of the images referred to by the HTML document.
f.  The other image referred to by the HTML document.

Here's what the MIME document looks like for the MIME tree outlined above, except that the encoded image data is elided to keep this to a reasonable length:
****
MIME-Version: 1.0 +
Content-Type: multipart/alternative; boundary="[red]#----=_Part_1_1911152052.1618240895083#"

--[red]#----=_Part_1_1911152052.1618240895083# +
Content-Type: text/plain; charset=UTF-8 +
Content-Transfer-Encoding: 7bit +

Who cares what I say in here? +
--[red]#----=_Part_1_1911152052.1618240895083# +
Content-Type: multipart/related; boundary="[blue]#----=_Part_0_1644231115.1618240895077#" +

--[blue]#----=_Part_0_1644231115.1618240895077# +
Content-Type: text/html; charset=UTF-8 +
Content-Transfer-Encoding: 7bit +

<html> +
    <p> +
       <img width="20" src="cid:0"/> +
       <img width="30" src="cid:1"/> +
       <img width="40" src="cid:0"/> +
       Look at the pretty image below! +
    </p> +
</html> +


--[blue]#----=_Part_0_1644231115.1618240895077# +
Content-Type: image/png +
Content-Transfer-Encoding: base64 +
Content-ID: <0> +
Content-Disposition: inline +


--[blue]#----=_Part_0_1644231115.1618240895077# +
Content-Type: image/jpeg +
Content-Transfer-Encoding: base64 +
Content-ID: <1> +
Content-Disposition: inline +


--[blue]#----=_Part_0_1644231115.1618240895077#-- +
--[red]#----=_Part_1_1911152052.1618240895083#-- +
****
A few things worth noting in this:

* The colored bits are boundary markers, which are between the pieces of a multipart node.  There are three boundary markers (in red) for the alternative multipart -- the first containing the plain text alternative, and the second the HTML alternative.  There are four boundary markers (in blue) within the HTML alternative, marking the boundaries of the three related leaf nodes: the HTML document and the two images.  This all looks like gobbledegook at first glance, but it's actually not hard to read or understand.
* At the start of each MIME piece there are _MIME headers_.  These are all the lines after the boundary, but before the blank line.  These are how the type of each MIME piece is encoded.
* The `<img/>` HTML tags have source URLs of the form "cis:<number>".  The "cis:" prefix is how the special URLs that refer to related items are formed.
* Note how the HTML alternative comes _after_ the plain text alternative.  This order tells the email client to render the HTML alternative if it can, but to fall back to the plain text alternative if it cannot.

==== Headers

There's one more piece of an email, one that's invisible to a normal user reading an email on an email client, but that's very important to how email works: that's the email headers.  Here's an example taken from an actual email (with some private information changed):
....
Delivered-To: tom@dilatush.com
Received: by 2002:ab3:1617:0:0:0:0:0 with SMTP id b23csp4814988lta;
        Tue, 30 Mar 2021 14:10:04 -0700 (PDT)
X-Received: by 2002:a9d:7e8d:: with SMTP id m13mr28412924otp.54.1617138603888;
        Tue, 30 Mar 2021 14:10:03 -0700 (PDT)
ARC-Seal: i=1; a=rsa-sha256; t=1617138603; cv=none;
        d=google.com; s=arc-20160816;
        b=LGXw4xpUCRqyqWE/z9KjgO5YBsk3unCauikBjNC92mJnQNMtC3CkBlkf6cGb/bv34E
         OO8b+t2l7ZQGUFr1Ri9jb5NyfBxVmOJu58u+OR3h2eKM6GLL8Q+3rvqkBXXGB5fsAaKe
         8SkqVzt9XYgMwxmaQqDs9s63LCKXxE50qkCZgKfk4WsT5z0TBCkq6qi6InI17uSb3qdP
         qZlqTrG4DxDj0crOCm7wsRAU/JKdUAPLuUC9CMe0+okkearSbvLbhbmpETqd2cETTb6W
         OlW3ub+YPPDprObTtGnZ3DgL6HJGAriF3wZyJQUm+rPyM6PmZbJg7jBbEdz/8HKNSHuN
         naEQ==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=google.com; s=arc-20160816;
        h=content-transfer-encoding:mime-version:subject:message-id:to:from
         :date:dkim-signature;
        bh=aNLzqLLf9B0IoZxm+ZlN89BgZuIGKLPQqRumylaJ5Uc=;
        b=TuuOMEbi8RuKlw2a3yv9KUoQfXFL/jaX8h4R/nmzVnax09d5Kve8Zmk6ZFlSxuaD45
         dKe49we2vHp7JCNVIJl/0ZMGxwH/0vL00FbnwI4/uaTuep/aXHbVSszeDrCAKGFSwdRl
         WhjfG9AC4LU7N8++3Yher9BlytH3dS8V5/TQ1PQPHZHFvtf179lF7hQS6GGEAfBFpQT7
         j8XAXCmybbUJguta6aC6f9XCq038pwy2xm9m9ez5FJawUAEEt4txvhb7Wua2jcq2g63h
         5hXKGjmGjODwLdMPy/dASTDEZeguX950y3kf/4D/ZRILWTV/REQhaRIfbQR9JIrzzcv2
         5DUg==
ARC-Authentication-Results: i=1; mx.google.com;
       dkim=pass header.i=@dilatush-com.20150623.gappssmtp.com header.s=20150623 header.b=N1A1lPUr;
       spf=neutral (google.com: 209.85.220.41 is neither permitted nor denied by best guess record for domain of burger@theshack.com) smtp.mailfrom=burger@theshack.com
Return-Path: <burger@theshack.com>
Received: from mail-sor-f41.google.com (mail-sor-f41.google.com. [209.85.220.41])
        by mx.google.com with SMTPS id a17sor18773otr.38.2021.03.30.14.10.03
        for <tom@dilatush.com>
        (Google Transport Security);
        Tue, 30 Mar 2021 14:10:03 -0700 (PDT)
Received-SPF: neutral (google.com: 209.85.220.41 is neither permitted nor denied by best guess record for domain of burger@theshack.com) client-ip=209.85.220.41;
Authentication-Results: mx.google.com;
       dkim=pass header.i=@dilatush-com.20150623.gappssmtp.com header.s=20150623 header.b=N1A1lPUr;
       spf=neutral (google.com: 209.85.220.41 is neither permitted nor denied by best guess record for domain of burger@theshack.com) smtp.mailfrom=burger@theshack.com
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=dilatush-com.20150623.gappssmtp.com; s=20150623;
        h=date:from:to:message-id:subject:mime-version
         :content-transfer-encoding;
        bh=aNLzqLLf9B0IoZxm+ZlN89BgZuIGKLPQqRumylaJ5Uc=;
        b=N1A1lPUrH7hF1ihsF3f617cR9lBZUzfAoi4wncvCHRKVTDsD2pSA+FBXAZ83F2c7kD
         RjT6T6EgpjIwyyxudb+hPhUQjoCa8lfwTDIu27tNp49NFEQp3zsm9GRvw5SGVHz4JeT2
         N7SlxGiJsVXZqjy64DgUgCR9VHNxCQK9S0CFY3erI4haWPUhuPbe8q6KAfZS/2vwyJyc
         wUA6IE0bsziacsK8oz3epG6p+N8XgfhXkqvSuigRXlhxcQEp8GK6pjzxv6jJcH+4LIOL
         qgCaJM0NRp6uP+9EBJEtU4CC61A7JdnE0ID4N5J+ECvenud+ZORGRnopE+OeWkLksYN3
         nDOg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:date:from:to:message-id:subject:mime-version
         :content-transfer-encoding;
        bh=aNLzqLLf9B0IoZxm+ZlN89BgZuIGKLPQqRumylaJ5Uc=;
        b=CXwG4EwsA+h1ePlWDXJ5AOOUPWAf6rCkHboIhS/ozSvnIX+b1r5Pf80wNe9h7B0sOX
         iSP+g5CfgDn4unTNw1DK17Xra6l3PHpr6PxuuMDOlR6DpkGs86MhE4GDxGmhRyiJzGVf
         S72QTiuSDFXcTRnmJLCJx/CFEZqJbJhyUb45XF8lvD6bBik+ZwDboLKWplDgUWevGX6S
         idjLvcgGzs8gaYQvDGh5LmF60SVXfEdIFFSr/1NSlIOTGrcA7Ah7fFb2CrjYoltyVw2G
         2ft3a5cyTDcLN3I5U2phVN9OE8u9IeDBuDBlPBNKQlA+CacrjpwpqoYgg6ULP5GKxSYM
         t48g==
X-Gm-Message-State: AOAM531HlBFNlJwnM3v/HBFHHBkkCMjnyIg6c3HnsXPPNPRub6g7/iGw
	voTxfL3vibDnVUOeew9EKfynigzWXq433sCW
X-Google-Smtp-Source: ABdhPJzjEAunQnlgITeEtpfcDttOkSoMDk5Q1CfIJuKRdf83QNlYFehTeT6ML9LcVmKSN61gbl7Qpg==
X-Received: by 2002:a9d:65c6:: with SMTP id z6mr28043870oth.232.1617138603203;
        Tue, 30 Mar 2021 14:10:03 -0700 (PDT)
Return-Path: <burger@theshack.com>
Received: from 10.3.254.57 (c-71-199-18-153.hsd1.ut.comcast.net. [71.199.18.153])
        by smtp.gmail.com with ESMTPSA id l191sm43088oih.16.2021.03.30.14.10.02
        for <tom@dilatush.com>
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Tue, 30 Mar 2021 14:10:02 -0700 (PDT)
Date: Tue, 30 Mar 2021 15:10:02 -0600 (MDT)
From: Burger Empire <burger@theshack.com>
To: tom@dilatush.com
Message-ID: <1422222071.0.1617138602673@[10.3.254.57]>
Subject: Test
....
A lot of these header fields are interesting; you can read about their meaning https://people.dsv.su.se/~jpalme/ietf/ietf-mail-attributes.html[here] (or do a little searching for the name of the header -- the part terminated by a colon(":")).  The headers are in reverse chronological order: the most recent headers appear first in the text.

What I found most interesting was the way you can read the history of how an email was forwarded from one email server to another (headers are added at each hop).  For our purposes here, though, there are only a few that matter:

* Date: The date and time that the message was written, which by default means when it was first transmitted to an SMTP server.
* From: What email address the email was sent from.  This email address is where replies from the client would go to.
* To: The email address this email is being sent to.
* Message-ID: A unique identifier for this email.  This can be very useful for correlating a reply to the email that provoked it.
* Subject: The subject line of the email.
* Return-Path: The email address that bounced (undeliverable) emails are sent to.  The domain for this should be the same as the from address -- otherwise email providers may tag you as a spammer.

== How _Email_ works

=== Email providers
_Email_ is configured with a list of email providers, with at least one provider being required for it to function.  For each provider, the configuration includes:

* The internal name of the provider, which acts as the "handle" by which the provider can be referenced.
* The _Session_ properties for the provider (this includes credentials).
* The limitations of the provider.  For example, if a provider only allows 500 free emails to be sent per day, that would be configured here.
* The priority for the provider, indicating whether this provider is more or less preferable than other providers.



=== Sending emails



=== Receiving emails


== Why does the world need Email?

I'm not sure the world actually does need _Email_, but I sure did!  I wanted to integrate email with some of my own applications that do these things:

* Send transactional emails.  For instance, personalized weather reports, system status to administrators, etc.  For these emails, I need more than just the email address -- I need some way to get the personalized content.
* Send bulk emails.  For instance, daily weather reports.

Then once I started to actually implement these functions, I realized that I want my email to work with multiple third-party providers -- for reliability, lower cost, and sometimes for features.  For example, if I have 5000 transactional emails per month, I can send chunks of that to four or five providers, staying below the "now you have to pay" thresholds on all of them.  If I sent them all via a single provider, I'd have to pay for most of them.


== Dependencies

_Email_ has several dependencies:

* _Util_ is a utilities module the author also wrote, freely available from https://github.com/SlightlyLoony/Util[here].
* _JSON_ is the bog-standard Java JSON module, freely available from https://github.com/stleary/JSON-java[here].
* _Jakarta Mail_ is the bog-standard Java email provider, freely available from https://eclipse-ee4j.github.io/mail/[here].  It's dependency the Jakarta Activation package is available https://eclipse-ee4j.github.io/jaf/[here].
* _JSoup_ is an open-source Java HTML parser, available https://jsoup.org/[here].

== Why is Email's code so awful?

The author is a retired software and hardware engineer who did this just for fun, and who (so far, anyway) has no code reviewers to upbraid him. Please feel free to fill in this gap! You may contact the author at link:mailto:[tom@dilatush.com].

== Transfer directories

_Email_ has the ability to send and receive emails with attachments.  When sending email attachments, the attachment data can come from either an object on a web server (via a URL) or a file in a _transfer directory_ that is readable by _Email_ (and in the case of an automatically deleting transfer directory, it must also be writable by _Email_.  When receiving email attachments, the data must go to a transfer directory that is writable by _Email_.  Transfer directories are specified by the _Email_ configuration file.

Each transfer directory has several attributes:
[cols="<,<"]
|===
|Attribute Name |Purpose

|name |The short name of the transfer directory.  This name is for human reference only, and is not part of the path to the directory.  It must follow the general rules of an identifier (on word, letters, numerals, and underscore).
|path |The absolute path to the transfer directory.  This path _must_ begin with a `/`.
|mode |The mode (`READ_ONLY`, `READ_WRITE`, `WRITE_ONLY`, or `READ_AUTO`) for the transfer directory.  See below for details)
|===

The possible operational modes:

* `READ_ONLY` : A read-only transfer directory, usable for sending attachments but not for receiving them.  After an attachment is sent from this directory, the file remains in the directory.
* `READ_AUTO` : An automatically deleting read-only transfer directory, usable for sending attachments but not for receiving them.  After an attachment is sent from this directory, the file is automagically deleted.
* `READ_WRITE`: A read/write transfer directory, usable for both sending and receiving attachments.
* `WRITE_ONLY`: A write-only transfer directory, usable for receiving attachments, but not for sending them.

== Some notes on email formatting when sending

The subject line and plain text email bodies are straightforward: they're encoded in UTF-8, and there are no other considerations.

HTML mail bodies have some important additional features: the ability to embed inline images, and the ability to embed attachments.  In both cases the actual data to be embedded can come from either of two places:

* _Web Server_: This is specified with an ordinary URL, starting with either `http://` or `https://` that addresses the image or file to be embedded.  If the specified URL is invalid (for any reason, including that the addressed object does not exist), an error will occur when attempting to send the email.  Note that objects read from a web server may be dynamically generated; there is no requirement that they be a static resource.
* _Transfer Directory_: This is specified with a special transfer URL, starting with `transfer://<transfer directory name>/<relative path>`, that specifies the transfer directory and relative path within the transfer directory to the object being inlined or attached.  If the file path is invalid (for any reason, including that the addressed object does not exist), an error will occur when attempting to send the email.  For example, the URL `transfer://horse/grooming.doc` refers to an object within the transfer directory named `horse` in a file named `grooming.doc`.  Transfer directories may contain subdirectories to any depth, so the URLs may be arbitrarily long.

Inline embedded images are specified in an `<img/>` tag, via the `src` attribute.  For example, the tag `<img width="10" src="https://something.com/excellent.jpg"/>` specifies an embedded image that will be read from the given URL.  All the rest of the details of embedding the image are handled by the email sender.  It's worth noting that if a given image is used multiple times in the email, it will only be embedded once.

Attachments are specified with the custom `<attach-file/>` tag, via the `src` attribute.  For example, the tag `attach-file src="file://horse/dropzone/excellent.doc" />` will attach a file named `excellent.doc` (the `.auto` part is stripped).  Note that `<attach-file/>` tags are deleted from the HTML that is actually sent in the email.

== Some notes on receiving emails

When _Email_ receives emails, it extracts the text from the plain text if possible.  If the email only has text in an HTML part, it extracts that text instead.  The text extracted (from either source) is then processed through an ordered list of _email routing rules_ that identify where the received email should be sent.  If no routing rule matches, the received email is logged and discarded.  If the sender (as identified in the email headers via IP address) is logged into an email session, then there will be a dynamic routing rule (processed before any static rules) that identifies where the email should be sent.

When an email _does_ match an email routing rule, several things happen:

* A standard MOP message (the _email received_ message) is constructed.  This message contains the sender's reported 'from' address, the subject line, the text extracted from the body of the email, the number of attachments (which of course may be zero), the session ID (if the email is part of a session), and the IP address of the sender.  This message will be addressed according to the routing rule, which specifies the destination post office and mailbox.

* If there are any attachments, they are stored in a temporary directory created for each received email, and stored in the transfer directory specified in the matched email routing rule.  The attachments are stored in that directory, with the name given to them in the email.  The temporary directory name is added to the email received message.

== How is Email licensed?

Email is licensed with the quite permissive MIT license:

....
Created: November 16, 2020
Author: Tom Dilatush link:mailto:tom@dilatush.com
Github: https://github.com/SlightlyLoony/Email
License: MIT

Copyright 2020, 2021 by Tom Dilatush (aka "SlightlyLoony")

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so.

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE A AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
....